# 社区医院门诊管理系统：数据库设计文档


## 1. 设计目标与原则

### 1.1 设计目标

- 支撑门诊业务闭环：预约、登记/签到、就诊、缴费离院、统计分析
- 保障数据一致性与完整性：外键、唯一性、检查约束、状态约束（由应用逻辑控制）
- 兼顾查询性能：为常用筛选字段与时间字段建立索引

### 1.2 设计原则

- **面向实体建模**：以业务实体（患者、预约、就诊、账单等）为核心拆表
- **规范化（3NF）**：减少冗余，避免更新异常
- **可扩展**：为后续扩展更多科室、更多排班、更多统计维度预留空间

## 2. 概念结构设计（E-R）

### 2.1 核心实体

- 科室（Department）
- 诊室（Room）
- 排班（Schedule）
- 员工（Employee）
- 系统账号（SysUser）
- 患者（Patient）
- 预约（Appointment）
- 就诊（Visit）
- 账单（Bill）
- 收入记录（IncomeRecord）
- 病历（MedicalRecord）
- 患者账号映射（PatientUser：将 patient 角色账号与患者主数据绑定）

### 2.2 E-R 关系说明

- 一个科室包含多个诊室、多个员工
- 一个诊室在某个日期/时间段对应一条排班；排班关联一个医生（员工）
- 一个患者可以创建多条预约；预约属于某个科室
- 预约到院签到后会生成一条就诊记录（预约与就诊是一对零/一关系）
- 就诊发生在某个诊室并可关联医生；就诊可生成一条账单（1:1）
- 缴费后会写入收入记录（通常为每个账单一条收入记录，数据库上允许扩展为 1:N）
- 每次就诊对应一份病历（1:1）
- 系统账号与员工/患者建立关联：员工账号直接引用 `employee.emp_id`；患者账号通过 `patient_user` 绑定到患者主数据

### 2.3 E-R 图（Mermaid）

直观表示可以见ER图
![ER图](../figures/ER.png)


```mermaid
erDiagram
  DEPARTMENT ||--o{ EMPLOYEE : contains
  DEPARTMENT ||--o{ ROOM : contains
  ROOM ||--o{ SCHEDULE : has
  EMPLOYEE ||--o{ SCHEDULE : assigned

  PATIENT ||--o{ APPOINTMENT : makes
  DEPARTMENT ||--o{ APPOINTMENT : for

  PATIENT ||--o{ VISIT : has
  ROOM ||--o{ VISIT : occurs_in
  EMPLOYEE ||--o{ VISIT : doctor
  APPOINTMENT ||--o| VISIT : converts_to

  VISIT ||--|| BILL : generates
  BILL ||--o{ INCOME_RECORD : records
  VISIT ||--|| MEDICAL_RECORD : has

  EMPLOYEE ||--o{ SYS_USER : account
  SYS_USER ||--o| PATIENT_USER : links
  PATIENT ||--o| PATIENT_USER : owns

  DEPARTMENT {
    INT dept_id PK
    VARCHAR dept_name UK
    TEXT description
    TIMESTAMP created_at
  }
  EMPLOYEE {
    VARCHAR emp_id PK
    VARCHAR name
    ENUM gender
    VARCHAR phone
    ENUM position
    VARCHAR title
    INT dept_id FK
    ENUM status
    TIMESTAMP created_at
  }
  SYS_USER {
    INT user_id PK
    VARCHAR emp_id FK
    VARCHAR username UK
    VARCHAR password_hash
    ENUM role
    ENUM status
    TIMESTAMP last_login
    TIMESTAMP created_at
  }
  ROOM {
    INT room_id PK
    VARCHAR room_number UK
    INT dept_id FK
    ENUM status
  }
  SCHEDULE {
    INT schedule_id PK
    INT room_id FK
    VARCHAR doctor_id FK
    DATE work_date
    ENUM time_slot
    INT max_patients
    INT current_patients
  }
  PATIENT {
    INT patient_id PK
    VARCHAR name
    ENUM gender
    VARCHAR id_card UK
    VARCHAR phone
    TIMESTAMP created_at
  }
  PATIENT_USER {
    INT user_id PK,FK
    INT patient_id UK,FK
    TIMESTAMP created_at
  }
  APPOINTMENT {
    INT appt_id PK
    VARCHAR patient_name
    VARCHAR phone
    INT dept_id FK
    DATETIME expected_time
    ENUM status
    INT patient_id FK
    TIMESTAMP created_at
  }
  VISIT {
    INT visit_id PK
    INT patient_id FK
    INT room_id FK
    VARCHAR doctor_id FK
    INT appt_id UK,FK
    ENUM status
    TIMESTAMP check_in_time
    TIMESTAMP checkout_time
  }
  BILL {
    INT bill_id PK
    INT visit_id UK,FK
    DECIMAL total_amount
    DECIMAL insurance_amount
    DECIMAL self_pay_amount
    ENUM pay_status
    TIMESTAMP pay_time
    TIMESTAMP created_at
  }
  INCOME_RECORD {
    INT record_id PK
    INT bill_id FK
    INT dept_id FK
    VARCHAR doctor_id FK
    DECIMAL amount
    DATE record_date
    TIMESTAMP created_at
  }
  MEDICAL_RECORD {
    INT record_id PK
    INT visit_id UK,FK
    TEXT diagnosis
    TEXT treatment
    TEXT prescription
    TEXT note
    TIMESTAMP created_at
    TIMESTAMP updated_at
  }
```

## 3. 逻辑结构设计（关系模式 / 表设计）

> 说明：以下以 `database/schema.sql` 为准；类型与约束与后端 SQLAlchemy 模型保持一致。

### 3.1 数据库与字符集

- 数据库：`community_hospital`
- 字符集：`utf8mb4`
- 存储引擎：`InnoDB`

### 3.2 数据字典（按表）

#### 3.2.1 `department`（科室表）

用途：维护医院科室基础信息。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `dept_id` | INT | PK, AI | 科室编号 |
| `dept_name` | VARCHAR(50) | NOT NULL, UNIQUE | 科室名称 |
| `description` | TEXT | NULL | 科室描述 |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### 3.2.2 `employee`（员工表）

用途：维护医生/护士/前台/管理员等员工信息。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `emp_id` | VARCHAR(20) | PK | 工号 |
| `name` | VARCHAR(50) | NOT NULL | 姓名 |
| `gender` | ENUM('男','女') | NOT NULL | 性别 |
| `phone` | VARCHAR(20) | NULL | 电话 |
| `position` | ENUM('医生','护士','前台','管理员') | NOT NULL | 岗位 |
| `title` | VARCHAR(50) | NULL | 职称（医生常用） |
| `dept_id` | INT | FK → `department.dept_id`, NULL | 所属科室（管理员可为空） |
| `status` | ENUM('在职','离职','休假') | NOT NULL, DEFAULT '在职' | 在职状态 |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### 3.2.3 `sys_user`（系统账号表）

用途：系统登录账号（统一身份），用 `role` 区分患者/前台/管理员。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `user_id` | INT | PK, AI | 账号 ID |
| `emp_id` | VARCHAR(20) | FK → `employee.emp_id`, NULL | 绑定员工（非患者） |
| `username` | VARCHAR(50) | NOT NULL, UNIQUE | 登录名 |
| `password_hash` | VARCHAR(255) | NOT NULL | 密码哈希（不存明文） |
| `role` | ENUM('patient','receptionist','admin') | NOT NULL | 角色 |
| `status` | ENUM('active','inactive') | NOT NULL, DEFAULT 'active' | 账号状态 |
| `last_login` | TIMESTAMP | NULL | 最近登录时间 |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### 3.2.4 `room`（诊室表）

用途：维护诊室及其所属科室、启停用状态。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `room_id` | INT | PK, AI | 诊室 ID |
| `room_number` | VARCHAR(20) | NOT NULL, UNIQUE | 诊室号 |
| `dept_id` | INT | NOT NULL, FK → `department.dept_id` | 所属科室 |
| `status` | ENUM('启用','停用') | NOT NULL, DEFAULT '启用' | 启停用 |

#### 3.2.5 `schedule`（排班表）

用途：维护“诊室-日期-时间段”的排班，并记录容量与已占用数量。

关键约束：

- 唯一键：`(room_id, work_date, time_slot)`，避免重复排班
- 检查约束：`current_patients <= max_patients`，避免超额（同时应用层也做校验与占位）

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `schedule_id` | INT | PK, AI | 排班 ID |
| `room_id` | INT | NOT NULL, FK → `room.room_id` | 诊室 |
| `doctor_id` | VARCHAR(20) | NOT NULL, FK → `employee.emp_id` | 医生 |
| `work_date` | DATE | NOT NULL | 日期 |
| `time_slot` | ENUM('上午','下午','全天') | NOT NULL | 时间段 |
| `max_patients` | INT | NOT NULL, DEFAULT 30 | 最大接诊数 |
| `current_patients` | INT | NOT NULL, DEFAULT 0 | 已占用数 |

索引：`work_date`（便于按日期查询排班）。

#### 3.2.6 `patient`（患者表）

用途：维护患者主数据（可由预约/登记产生）。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `patient_id` | INT | PK, AI | 患者 ID |
| `name` | VARCHAR(50) | NOT NULL | 姓名 |
| `gender` | ENUM('男','女') | NULL | 性别（可选） |
| `id_card` | VARCHAR(18) | UNIQUE, NULL | 身份证号（可选但唯一） |
| `phone` | VARCHAR(20) | NOT NULL | 手机号 |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

索引：`phone`、`id_card`（便于按电话/身份证查询）。

#### 3.2.7 `patient_user`（患者账号映射表）

用途：将 `sys_user.role='patient'` 的账号与 `patient` 主数据绑定，保证一个患者最多一个账号。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `user_id` | INT | PK, FK → `sys_user.user_id` | 患者账号 |
| `patient_id` | INT | NOT NULL, UNIQUE, FK → `patient.patient_id` | 绑定患者 |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

外键策略：`ON DELETE CASCADE`（删除账号/患者时自动清理映射）。

#### 3.2.8 `appointment`（预约表）

用途：记录患者预约信息；可由患者账号直接创建，也可作为“电话+姓名”预约记录存在。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `appt_id` | INT | PK, AI | 预约 ID |
| `patient_name` | VARCHAR(50) | NOT NULL | 预约姓名（快照） |
| `phone` | VARCHAR(20) | NOT NULL | 预约电话 |
| `dept_id` | INT | NOT NULL, FK → `department.dept_id` | 预约科室 |
| `expected_time` | DATETIME | NOT NULL | 预计到达时间 |
| `status` | ENUM('待确认','已确认','已完成','已取消') | NOT NULL, DEFAULT '待确认' | 预约状态 |
| `patient_id` | INT | NULL, FK → `patient.patient_id` | 关联患者（可为空） |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

索引：`phone`、`expected_time`（便于按电话/时间筛选）。

#### 3.2.9 `visit`（就诊记录表）

用途：记录患者一次到院就诊的全过程状态与时间，支持“预约转就诊”与“现场登记”两种来源。

关键点：

- `appt_id` 可为空（现场登记），但若不为空则必须唯一（一个预约最多生成一条就诊记录）
- `status` 控制流程流转（由应用层严格校验）

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `visit_id` | INT | PK, AI | 就诊 ID |
| `patient_id` | INT | NOT NULL, FK → `patient.patient_id` | 患者 |
| `room_id` | INT | NOT NULL, FK → `room.room_id` | 诊室 |
| `doctor_id` | VARCHAR(20) | NULL, FK → `employee.emp_id` | 医生 |
| `appt_id` | INT | NULL, UNIQUE, FK → `appointment.appt_id` | 来源预约（可为空） |
| `status` | ENUM('候诊中','就诊中','待缴费','已离院') | NOT NULL, DEFAULT '候诊中' | 就诊状态 |
| `check_in_time` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 登记/签到时间 |
| `checkout_time` | TIMESTAMP | NULL | 离院时间 |

索引：`status`、`check_in_time`（便于按状态与时间段统计/查询）。

#### 3.2.10 `bill`（账单表）

用途：记录一次就诊的收费信息；与就诊 1:1 绑定。

关键约束：

- `visit_id` UNIQUE：每次就诊最多一张账单
- `CHECK(total_amount = insurance_amount + self_pay_amount)`：金额恒等约束

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `bill_id` | INT | PK, AI | 账单 ID |
| `visit_id` | INT | NOT NULL, UNIQUE, FK → `visit.visit_id` | 就诊 |
| `total_amount` | DECIMAL(10,2) | NOT NULL, DEFAULT 0.00 | 总额 |
| `insurance_amount` | DECIMAL(10,2) | NOT NULL, DEFAULT 0.00 | 医保金额 |
| `self_pay_amount` | DECIMAL(10,2) | NOT NULL, DEFAULT 0.00 | 自费金额 |
| `pay_status` | ENUM('未支付','已支付') | NOT NULL, DEFAULT '未支付' | 支付状态 |
| `pay_time` | TIMESTAMP | NULL | 支付时间 |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

#### 3.2.11 `income_record`（收入记录表）

用途：用于报表统计的收入流水（按日期、科室、医生等维度）。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `record_id` | INT | PK, AI | 收入记录 ID |
| `bill_id` | INT | NOT NULL, FK → `bill.bill_id` | 关联账单 |
| `dept_id` | INT | NOT NULL, FK → `department.dept_id` | 科室 |
| `doctor_id` | VARCHAR(20) | NULL, FK → `employee.emp_id` | 医生（可为空） |
| `amount` | DECIMAL(10,2) | NOT NULL | 金额 |
| `record_date` | DATE | NOT NULL | 记账日期 |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |

索引：`record_date`（用于按日期统计）。

#### 3.2.12 `medical_record`（病历表）

用途：维护“每次就诊”的病历内容（管理员端可查看/更新）。

| 字段 | 类型 | 约束 | 说明 |
|---|---|---|---|
| `record_id` | INT | PK, AI | 病历 ID |
| `visit_id` | INT | NOT NULL, UNIQUE, FK → `visit.visit_id` | 就诊 |
| `diagnosis` | TEXT | NULL | 诊断 |
| `treatment` | TEXT | NULL | 处置/治疗 |
| `prescription` | TEXT | NULL | 处方 |
| `note` | TEXT | NULL | 备注 |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| `updated_at` | TIMESTAMP | NOT NULL, ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

## 4. 规范化与一致性设计

### 4.1 规范化（3NF）简述

- 每张表描述单一主题（科室/员工/患者/预约/就诊/账单等）
- 非主属性完全依赖主键，不依赖非主属性（避免冗余与更新异常）
- 通过外键关联表达实体间联系，减少重复字段

### 4.2 一致性约束

- **外键约束**：保证引用的科室/诊室/患者/员工/预约/就诊存在
- **唯一性约束**：
  - `sys_user.username`、`department.dept_name`、`room.room_number`、`patient.id_card`
  - `visit.appt_id` 唯一（一个预约最多一次签到转就诊）
  - `bill.visit_id`、`medical_record.visit_id` 唯一（就诊与账单/病历 1:1）
  - `patient_user.patient_id` 唯一（患者最多绑定一个账号）
- **检查约束（CHECK）**：
  - `schedule.current_patients <= schedule.max_patients`
  - `bill.total_amount = bill.insurance_amount + bill.self_pay_amount`

> 注：状态流转（预约/就诊）主要由应用层校验实现；数据库层以 ENUM 限定取值集合。

## 5. 索引与性能设计

系统常用检索条件与对应索引（见 `database/schema.sql`）：

- 预约：`appointment.phone`、`appointment.expected_time`
- 就诊：`visit.status`、`visit.check_in_time`
- 患者：`patient.phone`、`patient.id_card`
- 排班：`schedule.work_date`
- 收入：`income_record.record_date`

## 6. 初始化数据与数据加载

### 6.1 SQL 初始化脚本

- `database/schema.sql`：建库建表（含主键/外键/索引/检查约束）
- `database/init_data.sql`：基础数据（科室/诊室/员工/默认账号/简单排班）
- `database/test_data.sql`（可选）：少量测试数据（患者/预约等）

### 6.2 应用侧演示数据（可选）

后端支持 `AUTO_SEED=1` 时自动建表并写入演示数据（适合快速演示/联调）；严格按作业要求提交时可关闭此开关，改用 SQL 脚本初始化。

