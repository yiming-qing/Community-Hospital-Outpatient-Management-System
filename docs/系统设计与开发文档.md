# 社区医院门诊管理系统：系统设计与开发文档

文档版本：v1.0
更新时间：2025-12-23
项目代号：`community-hospital-system`
课程：数据库系统实验大作业

---

## 0. 修订记录

| 版本   | 日期      | 修改人                | 说明                                                               |
| ---- | ---------- | --------------------- | ------------------------------------------------------------------ |
| v1.0 | 2025-12-23 |  韩一鸣 宋彧实 郭知雨  | 汇总系统调查/分析/设计/数据库设计，并补齐开发实现、测试验收与部署运维说明 |

---

## 1. 引言

### 1.1 编写目的

本文档用于汇总“社区医院门诊管理系统”的需求调研、系统分析、系统设计、数据库设计与开发实现要点，形成一份可用于答辩展示、验收检查与后续维护的完整项目文档。

### 1.2 项目背景

开发社区医院门诊管理系统，实现患者预约挂号、现场就诊登记、缴费结算、病历管理等全流程数字化，并通过数据分析掌握患者就诊规律与科室负荷情况，为医生排班、药品储备和运营决策提供支持。

### 1.3 项目目标与范围

系统围绕门诊业务闭环实现：

* 患者网上预约 → 到院登记/签到 → 就诊状态流转 → 缴费结算 → 离院与统计
* 管理端排班维护、诊室维护、员工维护与统计报表

### 1.4 用户角色

* 患者（客户）
* 前台（挂号/收费人员）
* 管理人员（医务科/行政主管）

---

## 2. 系统调查（System Survey）

### 2.1 调查背景与目标

以社区医院门诊管理为应用背景，围绕预约挂号、到院登记、就诊流转与缴费结算等流程开展调研，梳理业务流程、数据流向与核心需求，为后续系统分析与数据库设计提供依据。

### 2.2 业务流程调研

门诊业务可概括为：

* 预约挂号阶段：患者线上提交预约信息，系统记录预约状态
* 到院登记与分诊阶段：前台核验预约或现场登记，分配诊室与医生
* 就诊与缴费阶段：记录费用总额、医保与自费金额并完成结算
* 离院与统计阶段：缴费后离院，数据用于统计与管理分析

### 2.3 用户角色调研

* 患者：关注预约是否成功、就诊是否顺畅、费用是否清晰
* 前台：负责预约处理、到院登记、状态维护与收费
* 管理人员：关注排班配置、收入统计、就诊情况分析

### 2.4 调查结论与初步需求

* 支持线上预约与现场登记并存
* 预约/就诊流程具备清晰状态划分与流转规则
* 缴费金额计算一致性可校验
* 管理端基于数据库进行统计与查询分析

---

## 3. 系统分析（System Analysis）

### 3.1 技术与实现形态

* 前端：Vue3 + Element Plus（患者端 / 前台端 / 管理员端）
* 后端：Python Flask（REST API + JWT 权限）
* 数据库：MySQL 8.0（作业要求）；开发/演示可选 SQLite

### 3.2 角色与权限

三类核心角色：

1. 患者（patient）：注册/登录、科室浏览、创建预约、查询/取消预约
2. 前台（receptionist）：现场登记、预约处理、到院签到、就诊流转、缴费结算、报表查询
3. 管理员（admin）：诊室/排班/员工维护、病历维护、账单/收入查询、统计报表

权限控制：

* 后端：JWT + 角色校验（`roles_required(...)`）
* 前端：路由 `meta.roles` 访问控制，不满足则跳转登录并清空登录态

### 3.3 核心业务流程

#### 3.3.1 预约 → 到院签到（预约转就诊）

1. 患者选择科室与预计到达时间，提交预约（待确认）
2. 前台确认/取消预约（已确认/已取消）
3. 到院后前台核验信息执行到院签到
4. 系统匹配可用排班，创建就诊记录（Visit），预约置为已完成

#### 3.3.2 现场登记（无预约）

1. 患者到院现场登记，前台录入信息与科室
2. 系统匹配可用排班并创建就诊记录（Visit）

#### 3.3.3 就诊状态流转 → 缴费离院

就诊状态：`候诊中 → 就诊中 → 待缴费 → 已离院`
在“待缴费”阶段录入费用，生成账单并写入收入记录，置就诊为“已离院”。

### 3.4 功能需求（模块拆解）

* 认证与用户：登录、患者注册、用户资料
* 患者端：科室列表、创建预约、查询/取消预约
* 前台端：预约处理、到院签到、现场登记、状态流转、缴费结算、患者查询、报表查询
* 管理员端：诊室管理、排班管理、员工管理、患者/就诊/账单/收入查询、病历维护、统计报表

### 3.5 非功能需求

* 一致性：状态流转受限；金额恒等；排班容量不超额
* 安全性：JWT 鉴权；密码哈希存储；按角色授权
* 可用性：一键启动脚本与默认演示数据；接口错误统一返回
* 性能：关键字段索引（电话/身份证/状态/日期/时间等）

---

## 4. 系统设计（System Design）

### 4.1 总体架构

采用 B/S 三层结构：

* 浏览器（Vue3）→ HTTP/JSON → 后端 API（Flask）→ ORM（SQLAlchemy）→ MySQL

（可放“总体架构图”于 `docs/figures/总体架构图.png`）

### 4.2 前端设计

* 路由按角色划分：公共（login/register）、患者端、前台端、管理员端
* 登录态：Token 与用户信息保存到 LocalStorage
* 权限：路由守卫检查登录与角色，不满足则重定向

### 4.3 后端设计

* 目录结构：`api/`（蓝图）、`models/`（模型）、`utils/`（鉴权/响应/错误）、`seed.py`
* 认证：登录签发 JWT（默认 8h）
* 授权：`roles_required(...)` 统一校验
* 统一返回：`ok(...)`；错误统一结构化 JSON

### 4.4 核心业务规则设计

* 预约状态机：`待确认/已确认/已完成/已取消`
* 就诊状态机：`候诊中/就诊中/待缴费/已离院`
* 排班容量：`current_patients <= max_patients`，分配时选择当前人数最少排班并占位 +1
* 缴费一致性：`total = insurance + self_pay` 且 `insurance <= total`
* 多表写入操作（签到、缴费）使用事务语义，失败回滚避免不一致

---

## 5. 数据库设计（Database Design）

（本章为《数据库设计文档》的汇总版，完整细节以 `docs/数据库设计.md` 与 `database/schema.sql` 为准）

### 5.1 设计目标与原则

* 支撑门诊闭环：预约、登记/签到、就诊、缴费离院、统计分析
* 保障一致性：外键/唯一/检查约束与应用层状态机校验
* 兼顾查询性能：常用条件字段建立索引

### 5.2 核心实体与关系

核心实体：Department、Room、Schedule、Employee、SysUser、Patient、Appointment、Visit、Bill、IncomeRecord、MedicalRecord、PatientUser。
关系：科室-诊室/员工（1:N）、诊室-排班（1:N）、预约转就诊（0/1:1）、就诊-账单/病历（1:1）、账单-收入记录（1:N 可扩展）。

### 5.3 一致性与约束

* 外键与唯一性约束：保证实体引用完整、关键字段不重复
* CHECK 约束：排班容量、账单金额恒等
* 状态流转：主要由应用层严格校验，数据库 ENUM 限定取值集合

### 5.4 索引设计

* 预约：phone、expected_time
* 就诊：status、check_in_time
* 患者：phone、id_card
* 排班：work_date
* 收入：record_date

---

## 6. 接口设计（API 设计）

接口按角色划分（URL 前缀）：

* `/api/auth/*`：登录/注册/资料/登出
* `/api/patient/*`：科室、预约
* `/api/receptionist/*`：登记、签到、状态流转、缴费、报表
* `/api/admin/*`：诊室/排班/员工维护与统计/查询/病历

接口清单可复用如下（答辩/报告展示用）：

### 6.1 认证 `/api/auth`

| 方法   | 路径          | 说明              |
| ---- | ----------- | --------------- |
| POST | `/login`    | 登录，返回 JWT       |
| POST | `/register` | 患者注册（创建患者+账号绑定） |
| GET  | `/profile`  | 获取当前用户信息        |
| POST | `/logout`   | 登出（前端清 token）   |

### 6.2 患者 `/api/patient`

| 方法     | 路径                        | 说明     |
| ------ | ------------------------- | ------ |
| GET    | `/departments`            | 科室列表   |
| POST   | `/appointments`           | 创建预约   |
| GET    | `/appointments/query`     | 查询我的预约 |
| DELETE | `/appointments/{appt_id}` | 取消预约   |

### 6.3 前台 `/api/receptionist`

| 方法   | 路径                               | 说明            |
| ---- | -------------------------------- | ------------- |
| GET  | `/appointments`                  | 预约列表          |
| PUT  | `/appointments/{appt_id}/status` | 更新预约状态        |
| POST | `/checkin/{appt_id}`             | 到院签到（预约转就诊）   |
| POST | `/register`                      | 现场登记就诊        |
| GET  | `/visits`                        | 就诊列表          |
| PUT  | `/visits/{visit_id}/status`      | 就诊状态流转        |
| POST | `/payment/{visit_id}`            | 缴费结算（账单+收入记录） |
| GET  | `/patients`                      | 患者信息查询        |
| GET  | `/bills`                         | 收费报表查询        |
| GET  | `/income-records`                | 收入记录查询        |

### 6.4 管理员 `/api/admin`

| 方法         | 路径                                  | 说明      |
| ---------- | ----------------------------------- | ------- |
| GET/POST   | `/rooms`                            | 诊室查询/新增 |
| PUT        | `/rooms/{room_id}`                  | 诊室编辑    |
| GET/POST   | `/schedules`                        | 排班查询/新增 |
| PUT/DELETE | `/schedules/{schedule_id}`          | 排班编辑/删除 |
| GET/POST   | `/employees`                        | 员工查询/新增 |
| PUT        | `/employees/{emp_id}`               | 员工编辑    |
| GET        | `/patients/search`                  | 患者查询    |
| GET        | `/visits/search`                    | 就诊查询    |
| GET/PUT    | `/visits/{visit_id}/medical-record` | 病历查询/更新 |
| GET        | `/bills`                            | 账单查询    |
| GET        | `/income-records`                   | 收入明细查询  |
| GET        | `/statistics/income`                | 收入统计    |
| GET        | `/statistics/visits`                | 就诊统计    |

---

## 7. 系统实现说明（Implementation Guide）

> 本章直接参考项目 README，给出可复现的开发/运行说明。

### 7.1 环境要求

* MySQL 8.0（作业要求，需提前启动服务）
* Python 3（Flask 后端）
* Node.js + npm（Vue3 前端）
* Windows PowerShell 5.1+（提供一键启动脚本 `start.ps1`）

### 7.2 项目目录结构

* `backend/`：Flask 后端（REST API + JWT）
* `frontend/`：Vue3 + Element Plus 前端（患者端 + 前台端 + 管理员端）
* `database/`：MySQL 建表/初始化/测试数据脚本
* `PLAN.md`：实现计划与需求对照
* `docs/系统分析与设计.md`：系统分析与总体设计文档
* `docs/数据库设计.md`：数据库设计文档

### 7.3 访问地址与代理

* 前端：`http://localhost:5173`
* 后端：`http://localhost:5000`（通常无需直接访问，前端通过 `/api` 代理转发）
* 前端默认通过 Vite 代理把 `/api` 转发到 `http://localhost:5000`（见 `frontend/vite.config.js`）
* 系统通过“登录账号的角色”自动分流：访问 `/` 会跳转到该角色默认工作台

### 7.4 一键启动（MySQL）

在项目根目录执行（会：初始化 MySQL 数据库 + 写入 `backend/.env` + 启动前后端）：

* `.\start.ps1 -MySqlUser root -MySqlHost 127.0.0.1 -MySqlPort 3306`

常用参数：

* `-MySqlExePath "C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe"`：mysql.exe 不在 PATH 时使用
* `-MySqlPassword your_password`：非交互输入密码（注意可能以明文写入 `.env` 或出现在 PowerShell 历史记录）
* `-IncludeTestData`：额外导入 `database/test_data.sql`
* `-AutoSeed`：写入 `AUTO_SEED=1`，启动后端时自动补齐演示数据（一般不建议与严格 SQL 初始化混用）

提示：

* 若 PowerShell 阻止脚本运行：`powershell -ExecutionPolicy Bypass -File .\start.ps1 ...`
* 首次运行会创建 `backend/.venv` 并安装依赖、以及在 `frontend/` 执行 `npm install`
* 停止方式：关闭脚本启动的两个新 PowerShell 窗口或在窗口内 Ctrl+C

### 7.5 手动启动（MySQL：严格按 SQL 初始化）

初始化数据库（按顺序执行）：

* `source database/schema.sql;`
* `source database/init_data.sql;`
* 可选：`source database/test_data.sql;`

配置后端连接（`backend/.env`，可复制 `backend/.env.example`）：

* `DATABASE_URL=mysql+pymysql://root:password@127.0.0.1:3306/community_hospital?charset=utf8mb4`
* `JWT_SECRET_KEY=change-me`

启动后端：

* `cd backend`
* `pip install -r requirements.txt`
* `python run.py`

启动前端：

* `cd frontend`
* `npm install`
* `npm run dev`

### 7.6 快速启动（SQLite：开发/演示用，非作业要求）

启动后端（初始化表 + 种子数据）：

* `cd backend`
* `pip install -r requirements.txt`
* `python run.py`

默认启用 `AUTO_SEED=1`：启动时自动创建表并填充演示数据；如需关闭可在 `backend/.env` 设置 `AUTO_SEED=0`。

启动前端：

* `cd frontend`
* `npm install`
* `npm run dev`

### 7.7 默认账号与角色

* 管理员：admin / admin123（登录后进入管理后台）
* 前台：reception / reception123（登录后进入前台工作台）
* 测试患者：patient1 / patient123（也可从登录页进入“患者注册”自行注册）

### 7.8 演示闭环（建议录屏脚本）

1. 患者端：注册/登录 → 预约挂号提交预约（得到 appt_id）
2. 前台端：预约处理 → 对预约点击到院签到（生成 visit_id，分配诊室/医生）
3. 前台端：就诊/缴费 → 状态候诊中 → 就诊中 → 待缴费
4. 前台端：对待缴费 visit 缴费结算 → 状态变已离院并生成收入记录

---

## 8. 测试与验收（Testing & Acceptance）

> 本章按 README 的“演示闭环”与功能入口给出验收用例（可直接用于答辩或检查）。

### 8.1 测试环境

* 数据库：MySQL 8.0（严格初始化脚本）或 SQLite（演示快速启动）
* 后端：Python 3 + Flask
* 前端：Node.js + npm + Vue3（Vite dev server）
* 浏览器：Chrome/Edge（建议）

### 8.2 验收策略

* 以角色划分验收：患者端 / 前台端 / 管理员端
* 以闭环流程为主：预约 → 签到 → 状态流转 → 缴费 → 统计
* 对关键一致性点做检查：状态机、排班容量、金额恒等、事务回滚

### 8.3 功能测试用例表（示例，可扩展）

| 用例编号  | 角色  | 功能          | 前置条件           | 操作步骤             | 预期结果                       |
| ----- | --- | ----------- | -------------- | ---------------- | -------------------------- |
| TC-01 | 患者  | 登录          | 存在 patient1 账号 | 输入账号密码登录         | 跳转患者工作台，右上角显示已登录           |
| TC-02 | 患者  | 创建预约        | 已登录            | 选择科室+预计到达时间提交    | 生成预约记录，状态为待确认/可查询          |
| TC-03 | 患者  | 取消预约        | 已登录且预约未完成      | 取消预约             | 预约状态变已取消/从可用列表移除           |
| TC-04 | 前台  | 预约确认        | 存在待确认预约        | 点击确认             | 预约状态变已确认                   |
| TC-05 | 前台  | 到院签到（预约转就诊） | 预约已确认          | 点击到院签到           | 生成 visit；预约变已完成；排班占位+1     |
| TC-06 | 前台  | 现场登记就诊      | 无预约患者到院        | 填写信息并登记          | 生成 patient + visit；分配诊室/医生 |
| TC-07 | 前台  | 状态流转        | 存在候诊中 visit    | 依次更新：候诊中→就诊中→待缴费 | 状态严格按顺序流转，不允许跳转            |
| TC-08 | 前台  | 缴费结算        | visit 为待缴费     | 录入总额/医保/自费并结算    | 生成/更新账单，生成收入记录，visit 变已离院  |
| TC-09 | 管理员 | 排班维护        | 管理员登录          | 新增/编辑排班          | 排班可查询，且不重复冲突（唯一键）          |
| TC-10 | 管理员 | 统计报表        | 已产生收入记录        | 选择日期范围查询统计       | 返回按科室/医生/日期分组的统计结果         |

> 实际提交时可在“实际结果”列标注“通过”，并附关键页面截图/录屏时间戳。

### 8.4 端到端验收（闭环）

验收脚本按 7.8 执行，重点检查：

* 预约生成 appt_id；签到生成 visit_id
* 就诊状态按顺序变化，禁止越级
* 缴费结算后：账单金额恒等成立；收入记录新增；就诊状态变已离院
* 管理员统计能查到该条收入并正确聚合

### 8.5 常见异常校验（推荐）

* 排班容量满：无法再分配新就诊（提示容量不足或无可用排班）
* 金额非法：如 `insurance > total` 或 `total != insurance+self`，接口拒绝并提示
* 未登录访问受限页面：前端路由守卫跳转登录
* token 失效：接口返回 401，前端提示重新登录

---

## 9. 部署与运维（Deployment & Ops）

### 9.1 运行方式

* 开发/演示：使用 `start.ps1`（MySQL 初始化 + 启动前后端）
* 严格作业：MySQL 按 SQL 脚本初始化后，分别启动后端与前端
* 快速演示：SQLite + AUTO_SEED=1（非作业要求）

### 9.2 配置项说明

* `DATABASE_URL`：数据库连接串（MySQL 或 SQLite）
* `JWT_SECRET_KEY`：JWT 签名密钥
* `AUTO_SEED`：是否自动建表并写入演示数据（开发/演示）

### 9.3 数据库备份与恢复（建议）

* 备份：使用 `mysqldump` 导出 `community_hospital`
* 恢复：导入备份 SQL 文件（确保字符集为 utf8mb4）

### 9.4 常见问题（FAQ）

* “选择科室为空”：数据库 `department` 无数据。优先用 `start.ps1` 初始化 MySQL，或 SQLite 模式确保 `AUTO_SEED=1`
* 登录后接口 401：刷新页面重新登录；如仍异常，清空浏览器 LocalStorage 后再试（旧 token 可能失效）
* PowerShell 脚本被阻止：`powershell -ExecutionPolicy Bypass -File .\start.ps1 ...`

---

## 10. 总结与展望

本系统完成门诊业务闭环的数字化实现：预约、登记/签到、就诊状态流转、缴费结算、病历维护与统计查询，并通过数据库约束与应用层状态机/事务保证关键一致性。
后续可扩展：更细粒度排班、药房库存与处方流转、通知提醒（短信/邮件）、密码找回功能、更严格的 token 失效策略与操作审计等。

---

## 附录

* 附录 A：开发步骤详细文档: (位于../docs) 包含系统调查、系统分析、系统设计、数据库设计四项核心文档
* 附录 B：API 接口清单（见第 6 章）
* 附录 C：核心图示: (位于../figures)