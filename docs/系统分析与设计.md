# 社区医院门诊管理系统：系统分析与总体设计

文档版本：v1.0  
更新时间：2025-12-20  
项目代号：`community-hospital-system`

## 1. 项目概述

本项目面向“社区医院门诊管理”场景，围绕 **预约挂号 → 到院登记/签到 → 就诊状态流转 → 缴费结算 → 统计查询/管理维护** 的闭环流程，开发一个 B/S 架构的数据库应用系统。

项目实现包含：

- **前端**：Vue3 + Element Plus（患者端 / 前台端 / 管理员端）
- **后端**：Python Flask（REST API + JWT 权限）
- **数据库**：MySQL 8.0（作业要求）；开发/演示可选 SQLite（便于快速启动）

## 2. 系统分析（System Analysis）

### 2.1 业务背景与目标

社区医院门诊日常业务包括：预约挂号、现场登记、分诊、就诊过程信息记录、缴费结算以及按科室/医生/日期的统计分析。系统目标是把这些流程数字化并落到数据库中，实现：

- 业务流程在线化与可追溯
- 数据一致性与完整性约束
- 统计分析（收入、就诊量、人次等）

### 2.2 角色与权限

系统定义三类核心角色（与实现一致）：

1. **患者（patient）**
   - 注册/登录
   - 查看科室信息
   - 创建预约、查询预约、取消预约
2. **前台（receptionist）**
   - 现场登记就诊（生成就诊记录）
   - 预约处理：确认/取消；到院核验后签到（预约转就诊）
   - 就诊状态流转、缴费结算、收费报表查询
   - 患者信息查询
3. **管理员（admin / 医务科）**
   - 诊室管理、排班管理
   - 员工管理
   - 患者/就诊/账单/收入明细查询
   - 病历维护
   - 统计报表（收入/就诊量）

权限控制方式：后端使用 JWT + 角色校验（`roles_required(...)`），前端路由通过 `meta.roles` 进行访问控制并在不满足时清空登录态。

### 2.3 核心业务流程（业务视角）

#### 2.3.1 预约 → 到院签到（预约转就诊）

1. 患者选择科室与预计到达时间，提交预约（状态：`待确认`）
2. 前台可将预约状态更新为 `已确认` 或 `已取消`
3. 患者到院后，前台核验手机号/身份证后执行“到院签到”
4. 系统为该预约匹配可用排班，创建就诊记录（Visit），并将预约置为 `已完成`

#### 2.3.2 现场登记（无预约）

1. 患者到院现场登记，前台录入基本信息与科室
2. 系统为其匹配可用排班并创建就诊记录（Visit）

#### 2.3.3 就诊状态流转 → 缴费离院

就诊记录状态依次流转：

`候诊中 → 就诊中 → 待缴费 → 已离院`

前台在“待缴费”阶段录入费用（总额/医保/自费），系统生成账单并写入收入记录，最后置就诊为“已离院”。

### 2.4 功能需求（按模块拆解）

#### 2.4.1 认证与用户

- 登录：账号密码校验，返回 JWT
- 患者注册：创建患者信息与账号映射（一个患者最多绑定一个账号）
- 用户资料：获取当前登录用户角色/绑定信息

#### 2.4.2 患者端

- 科室列表查询
- 创建预约（科室、预计到达时间）
- 查询我的预约（按状态筛选）
- 取消未完成预约

#### 2.4.3 前台端

- 预约列表查询、预约状态更新（确认/取消）
- 到院签到（预约转就诊）：核验信息、分配医生/诊室、写入就诊记录
- 现场登记就诊：创建患者、分配医生/诊室、写入就诊记录
- 就诊列表查询、状态流转
- 缴费结算：生成/更新账单、写入收入记录、就诊离院
- 患者信息查询
- 收费报表/收入记录查询（按条件筛选、分页）

#### 2.4.4 管理员端

- 诊室管理（新增/编辑、启停用）
- 排班管理（新增/编辑/删除）
- 员工管理（新增/编辑）
- 患者查询、就诊查询（多条件筛选、分页）
- 病历维护（按就诊维度查询/更新）
- 账单与收入明细查询
- 统计报表：收入统计、就诊量统计（按日期/科室/医生分组）

### 2.5 非功能需求

- **一致性**：关键状态流转受限；账单金额满足恒等约束；排班容量不超额
- **安全性**：JWT 鉴权；密码哈希存储（Werkzeug）；按角色授权访问
- **可用性**：一键启动脚本与默认演示数据；接口错误统一返回
- **性能**：关键筛选字段建立索引（如手机号、时间、状态、日期）

### 2.6 用例模型（简化）

> 说明：课程报告可将下述用例列表配合截图/流程图呈现；本项目使用“角色 + 用例列表 + 关键流程图”方式表达。

**患者**

- UC-P1：患者注册
- UC-P2：患者登录
- UC-P3：查看科室列表
- UC-P4：提交预约
- UC-P5：查询/取消预约

**前台**

- UC-R1：现场登记就诊
- UC-R2：预约确认/取消
- UC-R3：预约到院签到（预约转就诊）
- UC-R4：就诊状态流转
- UC-R5：缴费结算并生成收入记录
- UC-R6：患者信息查询/收费报表查询

**管理员**

- UC-A1：诊室管理
- UC-A2：排班管理
- UC-A3：员工管理
- UC-A4：患者/就诊/账单/收入明细查询
- UC-A5：病历维护
- UC-A6：统计报表查询

### 2.7 数据流分析（DFD，Level-0/Level-1 简化）

#### Level-0（上下文图）

```mermaid
flowchart LR
  Patient[患者] -->|预约/查询/取消| System[门诊管理系统]
  Reception[前台] -->|登记/签到/缴费/查询| System
  Admin[管理员] -->|排班/维护/统计/查询| System
  System -->|读写| DB[(数据库)]
```

#### Level-1（核心闭环：预约/就诊/缴费）

```mermaid
flowchart TD
  subgraph P1[过程 1：预约管理]
    P11[创建预约] --> P12[预约查询/取消]
  end

  subgraph P2[过程 2：到院登记/签到]
    P21[现场登记] --> P23[创建就诊记录]
    P22[预约签到核验] --> P23[创建就诊记录]
    P24[排班容量校验/占用] --> P23
  end

  subgraph P3[过程 3：就诊/缴费]
    P31[状态流转] --> P32[缴费结算]
    P32 --> P33[生成账单]
    P33 --> P34[写入收入记录]
  end

  Patient --> P11
  Patient --> P12
  Reception --> P21
  Reception --> P22
  Reception --> P31
  Reception --> P32
  Admin -->|排班维护| P24

  P1 --> DB[(数据库)]
  P2 --> DB
  P3 --> DB
```

## 3. 系统设计（System Design）

### 3.1 总体架构

采用典型 **B/S 三层结构**：

```mermaid
flowchart LR
  Browser[浏览器（Vue3）] -->|HTTP / JSON| API[后端 API（Flask）]
  API --> ORM[SQLAlchemy]
  ORM --> DB[(MySQL 8.0)]
```

说明：

- 前端通过 Vite 代理将 `/api` 转发到 `http://localhost:5000`（`frontend/vite.config.js`）
- 后端对外提供 REST API，统一 JSON 返回格式
- 数据库使用 InnoDB + 外键约束，确保关键关系完整性

### 3.2 前端设计

#### 3.2.1 页面与路由

路由以角色划分并做访问控制（`frontend/src/router/index.js`）：

- 公共：`/login`、`/register`
- 患者：`/patient/appointment`
- 前台：`/receptionist/register`、`/receptionist/appointments`、`/receptionist/visits`、`/receptionist/patients`、`/receptionist/bills`
- 管理员：`/admin/rooms`、`/admin/schedules`、`/admin/employees`、`/admin/statistics`、`/admin/patients`、`/admin/visits`、`/admin/bills`、`/admin/income-records`

#### 3.2.2 登录态与权限

- Token 与用户信息保存到 LocalStorage（`frontend/src/utils/storage`）
- 前端路由守卫：
  - 未登录访问受限页面 → 跳转登录并清空旧 token
  - 已登录访问 `/` → 按角色重定向到默认工作台

### 3.3 后端设计

#### 3.3.1 模块结构

后端主要目录（`backend/app`）：

- `api/`：按角色划分的蓝图（auth/patient/receptionist/admin）
- `models/`：SQLAlchemy 模型（与 MySQL 表结构对应）
- `utils/`：鉴权、时间解析、统一响应与错误处理
- `seed.py`：开发/演示环境自动建表与种子数据

#### 3.3.2 认证与授权

- 登录成功签发 JWT（8 小时有效）
- `roles_required(...)` 统一做：鉴权 → 用户状态校验 → 角色授权
- 当前实现不做 token 黑名单（登出由前端删除 token 实现）

#### 3.3.3 接口与职责划分

接口按角色划分（URL 前缀）：

- `/api/auth/*`：登录/注册/资料/登出
- `/api/patient/*`：科室、预约
- `/api/receptionist/*`：登记、签到、状态流转、缴费、报表
- `/api/admin/*`：维护（诊室/排班/员工）与统计/查询/病历

> 详细接口清单见“附录 A”。

#### 3.3.4 统一错误处理与返回

后端对错误统一封装为结构化 JSON（包含 `code`、`message`、`status` 等），便于前端展示与调试；正常响应统一 `ok(...)` 返回。

### 3.4 核心业务规则设计（与实现一致）

#### 3.4.1 预约状态机

- 状态集合：`待确认 / 已确认 / 已完成 / 已取消`
- 转移规则：
  - `待确认 → 已确认` 或 `待确认 → 已取消`
  - `已确认 → 已取消`
  - `已完成、已取消` 不再流转

```mermaid
stateDiagram-v2
  [*] --> 待确认
  待确认 --> 已确认
  待确认 --> 已取消
  已确认 --> 已取消
  待确认 --> 已完成 : 到院签到
```

#### 3.4.2 就诊状态机

- 状态集合：`候诊中 / 就诊中 / 待缴费 / 已离院`
- 转移规则：严格单向流转

```mermaid
stateDiagram-v2
  [*] --> 候诊中
  候诊中 --> 就诊中
  就诊中 --> 待缴费
  待缴费 --> 已离院 : 缴费结算
```

#### 3.4.3 排班容量控制

- `schedule.current_patients <= schedule.max_patients`
- 分配就诊时会在可用排班中选择 **当前人数最少** 的排班并做“占位 +1”，避免超额

#### 3.4.4 缴费结算一致性

缴费时必须满足：

- `insurance_amount <= total_amount`
- `total_amount = insurance_amount + self_pay_amount`

同时在数据库层也有 `CHECK` 约束（见 `database/schema.sql`）。

#### 3.4.5 事务与回滚

“签到（预约转就诊）”与“缴费结算”等涉及多表写入的操作在后端使用事务语义：

- 任一步失败 → 回滚，避免出现“预约已完成但就诊未生成”“账单生成但收入未记账”等不一致状态

### 3.5 运行与部署设计

#### 3.5.1 环境变量

后端主要配置（`backend/.env`）：

- `DATABASE_URL`：数据库连接串（MySQL 或 SQLite）
- `JWT_SECRET_KEY`：JWT 密钥
- `AUTO_SEED`：是否自动建表并写入演示数据（开发/演示用）

#### 3.5.2 启动方式

- 推荐：使用 `start.ps1` 进行 MySQL 初始化 + 启动前后端（`README.md`）
- 开发/演示：SQLite 模式下直接运行 `python run.py` 并自动建表/种子数据

---

## 附录 A：主要 API 接口清单（与实现一致）

> 说明：下表用于报告/答辩展示，详细参数与返回可结合接口源码（`backend/app/api/*`）补充。

### A.1 认证 `/api/auth`

| 方法 | 路径 | 说明 |
|---|---|---|
| POST | `/login` | 登录，返回 JWT |
| POST | `/register` | 患者注册（创建患者+账号绑定） |
| GET | `/profile` | 获取当前用户信息 |
| POST | `/logout` | 登出（前端清 token） |

### A.2 患者 `/api/patient`

| 方法 | 路径 | 说明 |
|---|---|---|
| GET | `/departments` | 科室列表 |
| POST | `/appointments` | 创建预约 |
| GET | `/appointments/query` | 查询我的预约 |
| DELETE | `/appointments/{appt_id}` | 取消预约 |

### A.3 前台 `/api/receptionist`

| 方法 | 路径 | 说明 |
|---|---|---|
| GET | `/appointments` | 预约列表 |
| PUT | `/appointments/{appt_id}/status` | 更新预约状态（确认/取消） |
| POST | `/checkin/{appt_id}` | 到院签到（预约转就诊） |
| POST | `/register` | 现场登记就诊 |
| GET | `/visits` | 就诊列表 |
| PUT | `/visits/{visit_id}/status` | 就诊状态流转 |
| POST | `/payment/{visit_id}` | 缴费结算（生成账单+收入记录，离院） |
| GET | `/patients` | 患者信息查询 |
| GET | `/bills` | 收费报表查询 |
| GET | `/income-records` | 收入记录查询 |

### A.4 管理员 `/api/admin`

| 方法 | 路径 | 说明 |
|---|---|---|
| GET/POST | `/rooms` | 诊室查询/新增 |
| PUT | `/rooms/{room_id}` | 诊室编辑 |
| GET/POST | `/schedules` | 排班查询/新增 |
| PUT/DELETE | `/schedules/{schedule_id}` | 排班编辑/删除 |
| GET/POST | `/employees` | 员工查询/新增 |
| PUT | `/employees/{emp_id}` | 员工编辑 |
| GET | `/patients/search` | 患者查询 |
| GET | `/visits/search` | 就诊查询 |
| GET/PUT | `/visits/{visit_id}/medical-record` | 病历查询/更新 |
| GET | `/bills` | 账单查询 |
| GET | `/income-records` | 收入明细查询 |
| GET | `/statistics/income` | 收入统计 |
| GET | `/statistics/visits` | 就诊统计 |

